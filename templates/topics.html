{% extends "base.html" %}

{% block title %}Temas de Conversación - WhatsApp CRM{% endblock %}

{% block content %}
<main class="flex-1 flex flex-col overflow-hidden">
    <!-- Header -->
    <header class="bg-white dark:bg-[#152a17] border-b border-gray-200 dark:border-gray-800 px-6 py-4">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold text-[#111812] dark:text-white">Temas de Conversación</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400">Categorías para clasificar conversaciones del
                    chatbot</p>
            </div>
            <button onclick="openCreateModal()"
                class="flex items-center gap-2 px-4 py-2 bg-primary text-white hover:bg-primary/90 rounded-lg text-sm font-medium transition-colors shadow-sm">
                <span class="material-symbols-outlined text-lg">add</span>
                Nuevo Tema
            </button>
        </div>
    </header>

    <!-- Topics Grid -->
    <div class="flex-1 overflow-auto p-6">
        <div id="topics-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Topics loaded via JS -->
        </div>
        <div id="empty-state" class="hidden text-center py-12">
            <span class="material-symbols-outlined text-6xl text-gray-300 dark:text-gray-600">category</span>
            <p class="mt-4 text-gray-500 dark:text-gray-400">No hay temas creados aún</p>
            <p class="text-sm text-gray-400 dark:text-gray-500">Crea tu primer tema para empezar a categorizar
                conversaciones</p>
        </div>
    </div>
</main>

<!-- Create/Edit Modal -->
<div id="topicModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50" onclick="closeModal()"></div>
    <div class="relative bg-white dark:bg-[#152a17] rounded-2xl shadow-2xl w-full max-w-lg mx-4">
        <div class="flex items-center justify-between p-6 pb-3">
            <h3 id="modal-title" class="text-lg font-semibold">Nuevo Tema</h3>
            <button onclick="closeModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="px-6 pb-4 space-y-4">
            <input type="hidden" id="edit-id" />

            <!-- Nombre -->
            <div>
                <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Nombre *</label>
                <input type="text" id="topic-name"
                    class="w-full px-4 py-2 border border-gray-200 dark:border-gray-700 dark:bg-gray-800 rounded-lg text-sm focus:outline-none focus:border-primary"
                    placeholder="Ej: Consultas de Afiliación" />
            </div>

            <!-- Descripción -->
            <div>
                <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Descripción</label>
                <textarea id="topic-description" rows="2"
                    class="w-full px-4 py-2 border border-gray-200 dark:border-gray-700 dark:bg-gray-800 rounded-lg text-sm focus:outline-none focus:border-primary resize-none"
                    placeholder="Describe qué tipo de conversaciones pertenecen a este tema..."></textarea>
            </div>

            <!-- Palabras clave -->
            <div>
                <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Palabras Clave</label>
                <div class="relative">
                    <div id="keywords-container"
                        class="min-h-[38px] border border-gray-200 dark:border-gray-700 rounded-lg px-2 py-1.5 flex flex-wrap gap-1.5 items-center focus-within:border-primary transition-colors"
                        onclick="document.getElementById('keyword-input').focus()">
                        <span id="keywords-pills"></span>
                        <input type="text" id="keyword-input"
                            class="flex-1 min-w-[80px] text-sm bg-transparent dark:text-white focus:outline-none placeholder-gray-400"
                            placeholder="Escribe y presiona Enter..." />
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-1">Presiona Enter para agregar cada palabra clave</p>
            </div>

            <!-- Color -->
            <div>
                <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Color</label>
                <div id="color-options" class="flex flex-wrap gap-2">
                    <button type="button" onclick="selectColor('blue')" data-color="blue"
                        class="color-btn w-8 h-8 rounded-full bg-blue-500 hover:ring-2 hover:ring-offset-2 hover:ring-blue-500 transition-all"></button>
                    <button type="button" onclick="selectColor('green')" data-color="green"
                        class="color-btn w-8 h-8 rounded-full bg-green-500 hover:ring-2 hover:ring-offset-2 hover:ring-green-500 transition-all"></button>
                    <button type="button" onclick="selectColor('red')" data-color="red"
                        class="color-btn w-8 h-8 rounded-full bg-red-500 hover:ring-2 hover:ring-offset-2 hover:ring-red-500 transition-all"></button>
                    <button type="button" onclick="selectColor('yellow')" data-color="yellow"
                        class="color-btn w-8 h-8 rounded-full bg-yellow-500 hover:ring-2 hover:ring-offset-2 hover:ring-yellow-500 transition-all"></button>
                    <button type="button" onclick="selectColor('purple')" data-color="purple"
                        class="color-btn w-8 h-8 rounded-full bg-purple-500 hover:ring-2 hover:ring-offset-2 hover:ring-purple-500 transition-all"></button>
                    <button type="button" onclick="selectColor('pink')" data-color="pink"
                        class="color-btn w-8 h-8 rounded-full bg-pink-500 hover:ring-2 hover:ring-offset-2 hover:ring-pink-500 transition-all"></button>
                    <button type="button" onclick="selectColor('orange')" data-color="orange"
                        class="color-btn w-8 h-8 rounded-full bg-orange-500 hover:ring-2 hover:ring-offset-2 hover:ring-orange-500 transition-all"></button>
                    <button type="button" onclick="selectColor('cyan')" data-color="cyan"
                        class="color-btn w-8 h-8 rounded-full bg-cyan-500 hover:ring-2 hover:ring-offset-2 hover:ring-cyan-500 transition-all"></button>
                </div>
            </div>
        </div>
        <div class="flex justify-end gap-3 p-6 pt-3 border-t border-gray-100 dark:border-gray-800">
            <button onclick="closeModal()"
                class="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors">
                Cancelar
            </button>
            <button id="save-btn" onclick="saveTopic()"
                class="px-4 py-2 text-sm font-medium bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                Guardar
            </button>
        </div>
    </div>
</div>

<script>
    let topics = [];
    let keywords = [];
    let selectedColor = 'blue';

    const colorClasses = {
        blue: 'bg-blue-500',
        green: 'bg-green-500',
        red: 'bg-red-500',
        yellow: 'bg-yellow-500',
        purple: 'bg-purple-500',
        pink: 'bg-pink-500',
        orange: 'bg-orange-500',
        cyan: 'bg-cyan-500'
    };

    const colorBgLight = {
        blue: 'bg-blue-500/10 text-blue-600 border-blue-500/20',
        green: 'bg-green-500/10 text-green-600 border-green-500/20',
        red: 'bg-red-500/10 text-red-600 border-red-500/20',
        yellow: 'bg-yellow-500/10 text-yellow-600 border-yellow-500/20',
        purple: 'bg-purple-500/10 text-purple-600 border-purple-500/20',
        pink: 'bg-pink-500/10 text-pink-600 border-pink-500/20',
        orange: 'bg-orange-500/10 text-orange-600 border-orange-500/20',
        cyan: 'bg-cyan-500/10 text-cyan-600 border-cyan-500/20'
    };

    async function loadTopics() {
        try {
            const resp = await fetch('/api/conversation-topics');
            topics = await resp.json();
            renderTopics();
        } catch (e) {
            console.error('Error loading topics:', e);
        }
    }

    function renderTopics() {
        const container = document.getElementById('topics-container');
        const emptyState = document.getElementById('empty-state');

        if (topics.length === 0) {
            container.classList.add('hidden');
            emptyState.classList.remove('hidden');
            return;
        }

        container.classList.remove('hidden');
        emptyState.classList.add('hidden');

        container.innerHTML = topics.map(topic => `
            <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-5 hover:shadow-lg transition-shadow">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <div class="w-4 h-4 rounded-full ${colorClasses[topic.color] || 'bg-blue-500'}"></div>
                        <h3 class="font-semibold text-lg">${escapeHtml(topic.name)}</h3>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="openEditModal(${topic.id})" class="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors">
                            <span class="material-symbols-outlined text-lg text-gray-500">edit</span>
                        </button>
                        <button onclick="deleteTopic(${topic.id})" class="p-1.5 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">
                            <span class="material-symbols-outlined text-lg text-red-500">delete</span>
                        </button>
                    </div>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">${escapeHtml(topic.description || 'Sin descripción')}</p>
                <div class="flex flex-wrap gap-1.5">
                    ${(topic.keywords || []).map(kw => `
                        <span class="px-2 py-0.5 text-xs rounded-md border ${colorBgLight[topic.color] || 'bg-blue-500/10 text-blue-600 border-blue-500/20'}">${escapeHtml(kw)}</span>
                    `).join('')}
                </div>
                <div class="mt-3 pt-3 border-t border-gray-100 dark:border-gray-800">
                    <span class="text-xs text-gray-400">${topic.session_count || 0} conversaciones</span>
                </div>
            </div>
        `).join('');
    }

    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function openCreateModal() {
        document.getElementById('topicModal').classList.remove('hidden');
        document.getElementById('modal-title').textContent = 'Nuevo Tema';
        document.getElementById('edit-id').value = '';
        document.getElementById('topic-name').value = '';
        document.getElementById('topic-description').value = '';
        keywords = [];
        renderKeywordPills();
        selectColor('blue');
    }

    function openEditModal(topicId) {
        const topic = topics.find(t => t.id === topicId);
        if (!topic) return;

        document.getElementById('topicModal').classList.remove('hidden');
        document.getElementById('modal-title').textContent = 'Editar Tema';
        document.getElementById('edit-id').value = topic.id;
        document.getElementById('topic-name').value = topic.name;
        document.getElementById('topic-description').value = topic.description || '';
        keywords = [...(topic.keywords || [])];
        renderKeywordPills();
        selectColor(topic.color || 'blue');
    }

    function closeModal() {
        document.getElementById('topicModal').classList.add('hidden');
    }

    function selectColor(color) {
        selectedColor = color;
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.classList.remove('ring-2', 'ring-offset-2');
            if (btn.dataset.color === color) {
                btn.classList.add('ring-2', 'ring-offset-2', `ring-${color}-500`);
            }
        });
    }

    function renderKeywordPills() {
        const container = document.getElementById('keywords-pills');
        container.innerHTML = keywords.map((kw, i) => `
            <span class="inline-flex items-center gap-0.5 px-2 py-0.5 rounded-md bg-primary/10 text-primary text-xs font-medium">
                ${escapeHtml(kw)}
                <span class="material-symbols-outlined text-base cursor-pointer hover:opacity-60" onclick="removeKeyword(${i})">close</span>
            </span>
        `).join('');
    }

    function removeKeyword(index) {
        keywords.splice(index, 1);
        renderKeywordPills();
    }

    // Keyword input handler
    document.getElementById('keyword-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const val = e.target.value.trim().toLowerCase();
            if (val && !keywords.includes(val)) {
                keywords.push(val);
                renderKeywordPills();
            }
            e.target.value = '';
        } else if (e.key === 'Backspace' && e.target.value === '' && keywords.length > 0) {
            keywords.pop();
            renderKeywordPills();
        }
    });

    async function saveTopic() {
        const topicId = document.getElementById('edit-id').value;
        const name = document.getElementById('topic-name').value.trim();
        const description = document.getElementById('topic-description').value.trim();

        if (!name) {
            alert('El nombre es requerido');
            return;
        }

        const payload = { name, description, keywords, color: selectedColor };
        const btn = document.getElementById('save-btn');
        btn.disabled = true;
        btn.textContent = 'Guardando...';

        try {
            const url = topicId ? `/api/conversation-topics/${topicId}` : '/api/conversation-topics';
            const method = topicId ? 'PUT' : 'POST';

            const resp = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await resp.json();
            if (data.success) {
                closeModal();
                loadTopics();
            } else {
                alert('Error: ' + (data.error || 'Unknown'));
            }
        } catch (e) {
            alert('Error: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Guardar';
        }
    }

    async function deleteTopic(topicId) {
        if (!confirm('¿Eliminar este tema? Las conversaciones asociadas quedarán sin categoría.')) return;

        try {
            const resp = await fetch(`/api/conversation-topics/${topicId}`, { method: 'DELETE' });
            const data = await resp.json();
            if (data.success) {
                loadTopics();
            } else {
                alert('Error: ' + (data.error || 'Unknown'));
            }
        } catch (e) {
            alert('Error: ' + e.message);
        }
    }

    // Init
    loadTopics();
</script>
{% endblock %}