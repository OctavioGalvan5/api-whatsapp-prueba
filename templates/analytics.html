<!DOCTYPE html>
<html class="light" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Analytics - WhatsApp CRM</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec25",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102212",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .hidden { display: none !important; }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-[#111812] dark:text-white min-h-screen">
    <div class="flex h-screen">
        <!-- Sidebar Navigation -->
        <aside class="w-16 bg-white dark:bg-[#152a17] border-r border-gray-200 dark:border-gray-800 flex flex-col items-center py-4 gap-2">
            <a href="/dashboard" class="p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Dashboard">
                <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">chat</span>
            </a>
            <a href="/contacts" class="p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Contactos">
                <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">group</span>
            </a>
            <a href="/tags" class="p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Etiquetas">
                <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">label</span>
            </a>
            <a href="/campaigns" class="p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Campañas">
                <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">campaign</span>
            </a>
            <a href="/failed-messages" class="p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Fallidos">
                <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">error</span>
            </a>
            <a href="/analytics" class="p-3 rounded-xl bg-primary/10 text-primary" title="Analytics">
                <span class="material-symbols-outlined">bar_chart</span>
            </a>
            <a href="/whatsapp-settings" class="p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors mt-auto" title="Configuración">
                <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">settings</span>
            </a>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white dark:bg-[#152a17] border-b border-gray-200 dark:border-gray-800 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-xl font-bold text-[#111812] dark:text-white">Analytics</h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Estadísticas detalladas de mensajes</p>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <div class="flex-1 overflow-auto p-6 custom-scrollbar">
                <!-- Stats Cards -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                    <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center mb-3">
                            <span class="material-symbols-outlined text-primary">mail</span>
                        </div>
                        <div class="text-2xl font-bold">{{ stats.total_messages }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Mensajes Totales</div>
                    </div>
                    <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center mb-3">
                            <span class="material-symbols-outlined text-blue-500">outgoing_mail</span>
                        </div>
                        <div class="text-2xl font-bold">{{ stats.outbound }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Enviados</div>
                    </div>
                    <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <div class="w-10 h-10 rounded-lg bg-purple-500/10 flex items-center justify-center mb-3">
                            <span class="material-symbols-outlined text-purple-500">inbox</span>
                        </div>
                        <div class="text-2xl font-bold">{{ stats.inbound }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Recibidos</div>
                    </div>
                    <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center mb-3">
                            <span class="material-symbols-outlined text-primary">visibility</span>
                        </div>
                        <div class="text-2xl font-bold">{{ stats.read }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Leídos</div>
                    </div>
                    <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <div class="w-10 h-10 rounded-lg bg-orange-500/10 flex items-center justify-center mb-3">
                            <span class="material-symbols-outlined text-orange-500">done_all</span>
                        </div>
                        <div class="text-2xl font-bold">{{ stats.delivered }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Entregados</div>
                    </div>
                    <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <div class="w-10 h-10 rounded-lg bg-red-500/10 flex items-center justify-center mb-3">
                            <span class="material-symbols-outlined text-red-500">error</span>
                        </div>
                        <div class="text-2xl font-bold">{{ stats.failed }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Fallidos</div>
                    </div>
                </div>

                <!-- Main Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="lg:col-span-2 bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">trending_up</span>
                            Mensajes por Día (últimos 30 días)
                        </h3>
                        <div class="h-[300px]">
                            <canvas id="messagesByDayChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">pie_chart</span>
                            Distribución de Estados
                        </h3>
                        <div class="h-[300px]">
                            <canvas id="statusDistChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Hour Charts -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">schedule</span>
                            Mensajes Enviados por Hora
                        </h3>
                        <div class="h-[200px]">
                            <canvas id="sentByHourChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-purple-500">visibility</span>
                            Mensajes Leídos por Hora
                        </h3>
                        <div class="h-[200px]">
                            <canvas id="readByHourChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- More Charts -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-blue-500">calendar_month</span>
                            Por Día de la Semana
                        </h3>
                        <div class="h-[200px]">
                            <canvas id="byDayOfWeekChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">swap_horiz</span>
                            Entrantes vs Salientes
                        </h3>
                        <div class="h-[200px]">
                            <canvas id="directionChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-orange-500">contacts</span>
                            Top Contactos
                        </h3>
                        <div class="h-[200px]">
                            <canvas id="topContactsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Template Performance -->
                {% if template_performance %}
                <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4 mb-6">
                    <h3 class="font-semibold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">description</span>
                        Rendimiento de Templates
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200 dark:border-gray-700">
                                    <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Template</th>
                                    <th class="text-center px-4 py-3 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Enviados</th>
                                    <th class="text-center px-4 py-3 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Leídos</th>
                                    <th class="text-center px-4 py-3 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Tasa de Lectura</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
                                {% for t in template_performance %}
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                                    <td class="px-4 py-3 text-sm font-medium max-w-[300px] truncate">{{ t.name }}</td>
                                    <td class="px-4 py-3 text-sm text-center font-semibold">{{ t.sent }}</td>
                                    <td class="px-4 py-3 text-sm text-center font-semibold">{{ t.read }}</td>
                                    <td class="px-4 py-3">
                                        <div class="flex items-center justify-center gap-2">
                                            <div class="w-16 h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                                <div class="h-full rounded-full {% if t.read_rate >= 70 %}bg-primary{% elif t.read_rate >= 40 %}bg-orange-500{% else %}bg-red-500{% endif %}" style="width: {{ t.read_rate }}%"></div>
                                            </div>
                                            <span class="text-sm font-bold {% if t.read_rate >= 70 %}text-primary{% elif t.read_rate >= 40 %}text-orange-500{% else %}text-red-500{% endif %}">{{ t.read_rate }}%</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}

                <!-- Best Hours & Read Rate -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">target</span>
                            Mejores Horarios para Enviar
                        </h3>
                        {% if insights.best_hours %}
                        <div class="grid grid-cols-3 gap-3">
                            {% for hour in insights.best_hours %}
                            <div class="bg-gray-50 dark:bg-gray-800/50 rounded-xl p-3 text-center">
                                <div class="text-2xl font-bold text-primary">{{ hour.hour }}:00</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ hour.rate }}% tasa</div>
                                <div class="text-xs text-gray-400 dark:text-gray-500">{{ hour.sent }} env / {{ hour.read }} leídos</div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-gray-500 dark:text-gray-400 text-center py-4">Se necesitan más datos</p>
                        {% endif %}
                    </div>
                    <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <span class="material-symbols-outlined text-purple-500">show_chart</span>
                            Tasa de Lectura por Hora
                        </h3>
                        <div class="h-[200px]">
                            <canvas id="readRateByHourChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Insights -->
                <div class="bg-white dark:bg-[#152a17] rounded-xl border border-gray-200 dark:border-gray-800 p-4">
                    <h3 class="font-semibold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">lightbulb</span>
                        Insights
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl">
                            <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0">
                                <span class="material-symbols-outlined text-primary">schedule</span>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold">Hora Pico</h4>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Mayor actividad a las <strong>{{ insights.peak_hour }}:00</strong> con {{ insights.peak_hour_count }} mensajes</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl">
                            <div class="w-10 h-10 rounded-lg bg-purple-500/10 flex items-center justify-center flex-shrink-0">
                                <span class="material-symbols-outlined text-purple-500">visibility</span>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold">Tasa de Lectura</h4>
                                <p class="text-xs text-gray-500 dark:text-gray-400">El <strong>{{ insights.read_rate }}%</strong> de mensajes son leídos</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl">
                            <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center flex-shrink-0">
                                <span class="material-symbols-outlined text-blue-500">calendar_month</span>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold">Día Más Activo</h4>
                                <p class="text-xs text-gray-500 dark:text-gray-400"><strong>{{ insights.busiest_day }}</strong> es el día con más mensajes</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl">
                            <div class="w-10 h-10 rounded-lg bg-orange-500/10 flex items-center justify-center flex-shrink-0">
                                <span class="material-symbols-outlined text-orange-500">analytics</span>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold">Promedio Diario</h4>
                                <p class="text-xs text-gray-500 dark:text-gray-400"><strong>{{ insights.avg_daily }}</strong> mensajes por día</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl">
                            <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0">
                                <span class="material-symbols-outlined text-primary">target</span>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold">Mejor Hora Lecturas</h4>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Más lecturas a las <strong>{{ insights.peak_read_hour }}:00</strong></p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3 p-3 bg-gray-50 dark:bg-gray-800/50 rounded-xl">
                            <div class="w-10 h-10 rounded-lg bg-purple-500/10 flex items-center justify-center flex-shrink-0">
                                <span class="material-symbols-outlined text-purple-500">description</span>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold">Templates Usados</h4>
                                <p class="text-xs text-gray-500 dark:text-gray-400"><strong>{{ insights.template_count }}</strong> templates diferentes</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const chartData = {{ chart_data | tojson | safe }};

        // Color palette
        const colors = {
            green: '#13ec25',
            blue: '#0ea5e9',
            purple: '#8b5cf6',
            red: '#ef4444',
            orange: '#f97316',
            yellow: '#eab308'
        };

        // Chart defaults
        Chart.defaults.font.family = 'Inter';
        Chart.defaults.color = '#64748b';

        // Messages by Day
        if (chartData.messages_by_day) {
            new Chart(document.getElementById('messagesByDayChart'), {
                type: 'line',
                data: {
                    labels: chartData.messages_by_day.map(d => d.date),
                    datasets: [
                        {
                            label: 'Enviados',
                            data: chartData.messages_by_day.map(d => d.outbound || 0),
                            borderColor: colors.green,
                            backgroundColor: 'rgba(19, 236, 37, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Recibidos',
                            data: chartData.messages_by_day.map(d => d.inbound || 0),
                            borderColor: colors.blue,
                            backgroundColor: 'rgba(14, 165, 233, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Status Distribution
        if (chartData.status_dist) {
            new Chart(document.getElementById('statusDistChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Leídos', 'Entregados', 'Enviados', 'Fallidos'],
                    datasets: [{
                        data: [
                            chartData.status_dist.read || 0,
                            chartData.status_dist.delivered || 0,
                            chartData.status_dist.sent || 0,
                            chartData.status_dist.failed || 0
                        ],
                        backgroundColor: [colors.purple, colors.green, colors.blue, colors.red]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' } }
                }
            });
        }

        // Sent by Hour
        if (chartData.sent_by_hour) {
            new Chart(document.getElementById('sentByHourChart'), {
                type: 'bar',
                data: {
                    labels: chartData.sent_by_hour.map(d => `${d.hour}h`),
                    datasets: [{
                        label: 'Enviados',
                        data: chartData.sent_by_hour.map(d => d.count),
                        backgroundColor: colors.green,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Read by Hour
        if (chartData.read_by_hour) {
            new Chart(document.getElementById('readByHourChart'), {
                type: 'bar',
                data: {
                    labels: chartData.read_by_hour.map(d => `${d.hour}h`),
                    datasets: [{
                        label: 'Leídos',
                        data: chartData.read_by_hour.map(d => d.count),
                        backgroundColor: colors.purple,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // By Day of Week
        if (chartData.by_day_of_week) {
            new Chart(document.getElementById('byDayOfWeekChart'), {
                type: 'bar',
                data: {
                    labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
                    datasets: [{
                        data: chartData.by_day_of_week,
                        backgroundColor: colors.blue,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Direction Chart
        if (chartData.direction) {
            new Chart(document.getElementById('directionChart'), {
                type: 'pie',
                data: {
                    labels: ['Entrantes', 'Salientes'],
                    datasets: [{
                        data: [chartData.direction.inbound, chartData.direction.outbound],
                        backgroundColor: [colors.blue, colors.green]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // Top Contacts
        if (chartData.top_contacts) {
            new Chart(document.getElementById('topContactsChart'), {
                type: 'bar',
                data: {
                    labels: chartData.top_contacts.map(c => c.phone.slice(-4)),
                    datasets: [{
                        data: chartData.top_contacts.map(c => c.count),
                        backgroundColor: colors.orange,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true } }
                }
            });
        }

        // Read Rate by Hour Chart
        const hourlyReadRate = {{ hourly_read_rate | tojson | safe }};
        if (hourlyReadRate && hourlyReadRate.length > 0) {
            new Chart(document.getElementById('readRateByHourChart'), {
                type: 'line',
                data: {
                    labels: hourlyReadRate.map(h => `${h.hour}h`),
                    datasets: [{
                        label: 'Tasa de Lectura %',
                        data: hourlyReadRate.map(h => h.rate),
                        borderColor: colors.purple,
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: v => v + '%' }
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>
